
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vehicle Inspection Pipeline (AI)</title>
    <style>
      body { 
        font-family: Arial, sans-serif; 
        margin: 2rem; 
        background: #f5f5f5;
      }
      .container { 
        max-width: 1400px; 
        margin: 0 auto; 
        background: white; 
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      .main-layout {
        display: flex;
        gap: 2rem;
        margin-top: 2rem;
      }
      .left-panel {
        flex: 2;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .right-panel {
        flex: 1;
      }
      h1 { 
        text-align: center; 
        color: #d32f2f;
        margin-bottom: 2rem;
      }
      .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 1rem;
        font-size: 1.1rem;
      }
      .mode-selector {
        text-align: center;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #ddd;
      }
      .mode-selector label {
        margin-right: 1rem;
        font-weight: bold;
        color: #333;
      }
      .mode-selector input[type="radio"] {
        margin-right: 0.5rem;
        margin-left: 1rem;
      }
      .mode-info {
        font-size: 0.9rem;
        color: #666;
        margin-top: 0.5rem;
      }
      .camera-section {
        padding: 1rem;
        border: 2px solid #007bff;
        border-radius: 8px;
        background: #f8f9ff;
        height: fit-content;
      }
      .camera-section h3 {
        color: #007bff;
        margin-bottom: 1rem;
        text-align: center;
      }
      .camera-container {
        position: relative;
        border: 2px solid #007bff;
        border-radius: 8px;
        overflow: hidden;
        background: #000;
      }
      #cameraFeed {
        width: 100%;
        max-width: 480px;
        height: auto;
        display: block;
      }
      .camera-controls {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
      }
      .results-section {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1rem;
        background: #f9f9f9;
        min-height: 600px;
      }
      .results-section h3 {
        color: #333;
        margin-bottom: 1rem;
        text-align: center;
      }
      #captureBtn {
        background: #28a745;
        color: white;
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        transition: all 0.3s ease;
      }
      #captureBtn:hover {
        background: #218838;
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(40, 167, 69, 0.4);
      }
      #captureBtn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .camera-status {
        font-size: 0.8rem;
        font-weight: normal;
      }
      .no-results {
        text-align: center;
        color: #666;
        padding: 2rem;
        font-style: italic;
      }
      .images {
        display: flex;
        gap: 1rem;
      }
      .image-box {
        flex: 1;
        text-align: center;
      }
      .image-box h4 {
        margin-bottom: 0.5rem;
        color: #555;
        font-size: 0.9rem;
      }
      .image-box img {
        width: 100%;
        height: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .report-section {
        margin-top: 1rem;
        padding: 1rem;
        background: #f0f8ff;
        border: 1px solid #007bff;
        border-radius: 5px;
        text-align: center;
      }
      .report-section h4 {
        color: #007bff;
        margin-bottom: 0.5rem;
        font-size: 1rem;
      }
      .report-section p {
        margin: 0.3rem 0;
        font-size: 0.9rem;
      }
      .report-btn {
        display: inline-block;
        background: #007bff;
        color: white;
        padding: 0.5rem 1rem;
        text-decoration: none;
        border-radius: 4px;
        margin-top: 0.5rem;
        font-size: 0.9rem;
        transition: background 0.3s ease;
      }
      .report-btn:hover {
        background: #0056b3;
        text-decoration: none;
        color: white;
      }
      button { 
        background: #d32f2f; 
        color: white; 
        padding: 0.7rem 1.5rem; 
        border: none; 
        border-radius: 4px; 
        cursor: pointer; 
      }
      button:hover { 
        background: #b71c1c; 
      }
      button:disabled { 
        background: #ccc; 
        cursor: not-allowed; 
      }
      .loading { 
        display: none; 
        text-align: center; 
        padding: 2rem; 
      }
      .loading.show { 
        display: block; 
      }
      
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Simple Warning Popup */
      .warning-popup {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #ff9800;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        display: none;
        z-index: 1000;
        font-weight: 600;
        transform: translateX(100%);
        transition: transform 0.3s ease;
      }
      
      .warning-popup.show {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transform: translateX(0);
      }
      
      .warning-icon {
        font-size: 1.2rem;
      }
      
      @media (max-width: 768px) {
        .main-layout {
          flex-direction: column;
        }
        .images { 
          flex-direction: column; 
        }
        body {
          margin: 1rem;
        }
        .warning-popup {
          top: 10px;
          right: 10px;
          padding: 0.8rem 1rem;
        }
        .container {
          max-width: 100%;
          padding: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Vehicle Inspection Pipeline (AI)</h1>
      <div class="subtitle">Real-time Vehicle Defect & Surface Quality Detection</div>
      
      <div class="mode-selector">
        <label>Detection Mode:</label>
        <input type="radio" id="fasterrcnnOnly" name="detectionMode" value="fasterrcnn_only" checked>
        <label for="fasterrcnnOnly">üîç FasterRCNN Only (Fast)</label>
        
        <input type="radio" id="fasterrcnnSam2" name="detectionMode" value="fasterrcnn_sam2">
        <label for="fasterrcnnSam2">üîçü§ñ FasterRCNN + SAM2 (Complete)</label>
        
        <div class="mode-info">
          <div id="modeDescription">Detects dents and scratches using FasterRCNN (faster processing)</div>
        </div>
      </div>
      
      <div class="main-layout">
        <!-- Left Panel - Results -->
        <div class="left-panel">
          <div class="results-section">
            <h3>Detection Results</h3>
            <div class="loading" id="loading" style="display: none;">
              <div class="spinner"></div>
              <p>Processing image...</p>
            </div>
            <div class="results-content" id="results" style="display: none;">
              <div class="images" id="imageComparison">
                <!-- Images will be populated here -->
              </div>
            </div>
            <div id="noResults" class="no-results">
              <p>Click "Capture & Analyze" to detect defects</p>
            </div>
          </div>
        </div>

        <!-- Right Panel - Camera -->
        <div class="right-panel">
          <div class="camera-section">
            <h3>LIVE CAMERA FEED <span id="cameraStatus" class="camera-status">üü¢ Ready</span></h3>
            <div class="camera-container">
              <img id="cameraFeed" src="/video_feed" alt="Camera Feed" onerror="handleCameraError()" onload="handleCameraLoad()" />
              <div class="camera-controls">
                <button id="captureBtn" type="button">üì∏ Capture & Analyze</button>
              </div>
            </div>
          </div>
          
          <!-- Report Section -->
          <div class="report-section" id="reportSection" style="display: none;">
            <h4>Inspection Report</h4>
            <p><strong>Report ID:</strong> <span id="reportId">-</span></p>
            <p><strong>Total Defects:</strong> <span id="totalDefects">0</span></p>
            <a href="#" id="reportBtn" target="_blank" class="report-btn">üìÑ View Full Report (PDF)</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Simple Warning Popup -->
    <div class="warning-popup" id="warningPopup">
      <span class="warning-icon">‚ö†Ô∏è</span>
      <span class="warning-text" id="warningText">Defects detected!</span>
    </div>

    <script>
      const loading = document.getElementById('loading');
      const results = document.getElementById('results');
      const imageComparison = document.getElementById('imageComparison');
      const noResults = document.getElementById('noResults');
      const captureBtn = document.getElementById('captureBtn');
      const cameraStatus = document.getElementById('cameraStatus');
      const reportSection = document.getElementById('reportSection');
      const reportId = document.getElementById('reportId');
      const totalDefects = document.getElementById('totalDefects');
      const reportBtn = document.getElementById('reportBtn');
      const warningPopup = document.getElementById('warningPopup');
      const warningText = document.getElementById('warningText');
      const modeDescription = document.getElementById('modeDescription');

      function handleCameraError() {
        cameraStatus.textContent = 'üî¥ Camera Unavailable';
        captureBtn.disabled = true;
        captureBtn.textContent = 'üì∏ Camera Not Available';
      }

      function handleCameraLoad() {
        cameraStatus.textContent = 'üü¢ Camera Active';
        captureBtn.disabled = false;
        captureBtn.textContent = 'üì∏ Capture & Analyze';
      }

      // Check camera status on page load
      async function checkCameraStatus() {
        try {
          const response = await fetch('/api/camera/status');
          if (response.ok) {
            cameraStatus.textContent = 'üü¢ Camera Ready';
            captureBtn.disabled = false;
            captureBtn.textContent = 'üì∏ Capture & Analyze';
          } else {
            handleCameraError();
          }
        } catch (error) {
          console.error('Camera status check failed:', error);
          handleCameraError();
        }
      }

      // Initialize camera status check
      checkCameraStatus();

      // Handle mode switching
      document.querySelectorAll('input[name="detectionMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.value === 'fasterrcnn_only') {
            modeDescription.textContent = 'Detects dents and scratches using FasterRCNN (faster processing)';
          } else if (this.value === 'fasterrcnn_sam2') {
            modeDescription.textContent = 'Detects dents, scratches, and surface defects using FasterRCNN + SAM2 (complete inspection)';
          }
        });
      });

      function showWarning(message) {
        warningText.textContent = message;
        warningPopup.classList.add('show');
        
        // Auto-hide after 4 seconds
        setTimeout(() => {
          warningPopup.classList.remove('show');
        }, 4000);
      }

      // Camera capture functionality
      captureBtn.addEventListener('click', async () => {
        // Show loading, hide other sections
        loading.style.display = 'block';
        results.style.display = 'none';
        noResults.style.display = 'none';
        captureBtn.disabled = true;
        captureBtn.textContent = 'üì∏ Capturing...';

        try {
          // Get selected detection mode
          const selectedMode = document.querySelector('input[name="detectionMode"]:checked').value;
          
          const response = await fetch('/api/capture', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              detection_mode: selectedMode
            })
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || 'Capture failed');
          }

          // Hide loading, show results
          loading.style.display = 'none';
          results.style.display = 'block';
          noResults.style.display = 'none';

          // Process and display results
          processResults(data, selectedMode);

        } catch (error) {
          console.error('Error:', error);
          alert('Error capturing image: ' + error.message);
          loading.style.display = 'none';
          noResults.style.display = 'block';
        } finally {
          captureBtn.disabled = false;
          captureBtn.textContent = 'üì∏ Capture & Analyze';
        }
      });

      function processResults(data, selectedMode, isCapture = false) {
        // Show warnings for defects and surface defects
        const detections = data.defects || [];
        const surfaceDefects = data.surface_defects || [];
        
        let warnings = [];
        
        if (detections.length > 0) {
          const defectCount = detections.length;
          const defectTypes = [...new Set(detections.map(d => d.class || d.defect_type))].join(', ');
          warnings.push(`${defectCount} defect(s) detected: ${defectTypes}`);
        }
        
        if (selectedMode === 'fasterrcnn_sam2' && surfaceDefects && surfaceDefects.length > 0) {
          const highConfidenceDefects = surfaceDefects.filter(s => s.score > 0.7).length;
          const surfaceDefectTypes = [...new Set(surfaceDefects.map(s => s.class))].join(', ');
          
          if (highConfidenceDefects > 0) {
            warnings.push(`üé® SURFACE ISSUES: ${highConfidenceDefects} high-confidence surface defect(s) found!`);
          }
          warnings.push(`${surfaceDefects.length} surface defect(s): ${surfaceDefectTypes}`);
        }
        
        // Show overall status
        const overallStatus = data.overall_status || 'UNKNOWN';
        if (overallStatus === 'FAIL') {
          warnings.unshift('üö® INSPECTION FAILED');
        } else if (overallStatus === 'MINOR_ISSUES') {
          warnings.unshift('‚ö†Ô∏è Minor issues detected');
        } else if (overallStatus === 'PASS') {
          if (selectedMode === 'fasterrcnn_only') {
            warnings.push('‚úÖ Defect Check PASSED');
          } else {
            warnings.push('‚úÖ Full Inspection PASSED');
          }
        }
        
        // Show mode-specific messages
        if (selectedMode === 'fasterrcnn_only') {
          if (detections.length === 0) {
            warnings.push('‚úÖ No defects detected (FasterRCNN mode)');
          }
        } else {
          if (detections.length === 0 && surfaceDefects.length === 0) {
            warnings.push('‚úÖ No defects or surface issues detected');
          }
        }
        
        if (warnings.length > 0) {
          showWarning(warnings.join(' | '));
        }

        // Show images in results area
        if (data.original_image && data.visualization) {
          imageComparison.innerHTML = `
            <div class="image-box">
              <h4>Captured Image</h4>
              <img src="${data.original_image}" alt="Captured Image" />
            </div>
            <div class="image-box">
              <h4>Detection Results</h4>
              <img src="${data.visualization}" alt="Detection Results" />
            </div>
          `;
        }

        // Update report section below camera
        if (data.report_id && data.report_pdf_url) {
          reportId.textContent = data.report_id;
          totalDefects.textContent = data.total_defects || 0;
          reportBtn.href = data.report_pdf_url;
          reportSection.style.display = 'block';
        } else {
          reportSection.style.display = 'none';
        }
      }

    </script>
  </body>
</html>
